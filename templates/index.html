<!doctype html>
<html>
    <head>
        <link rel="stylesheet" href="../static/bootstrap.min.css"></link>
        <script href="../static/bootstrap.bundle.js"></script>
        <script href="../static/jquery.js"></script>
        <script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
        
        <style>
            #map {
                height: 750px;
            }
            html, body {
                height: 100%;
                margin: 0;
                padding: 0;
            }
            body {
                overflow-y:hidden;
            }

            .table-fixed thead {
                width: 97%;
            }
            .table-fixed tbody {
                height:650px;
                display : none;
                overflow-y: auto;
                width: 100%;
            }
            
            tr {
                height: 50px;
                
                overflow-y:none;
            }

            .table-fixed thead, .table-fixed tbody, .table-fixed tr, .table-fixed td, .table-fixed th {
                display: block;
            }
            .table-fixed tbody td, .table-fixed thead > tr> th {
                float: left;
                border-bottom-width: 0;
            }
        </style>
    </head>
    <body>
            
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <!--<h1>TrickleTracker</h1>
                    <h3>Water availability predictions for backcountry water sources.</h3>-->
                    <img src="../static/img/banner.png" class="img-fluid"></img>
                </div>

                <div class="col-lg-6">
                    <div id="map" width=100% height=750px></div>
                </div>

                <div class="col-lg-6">
                    <div class="row" style="margin-bottom: 10px;">
                        <div class="col-3 col-sm-3">
                            <input type="text" class="form-control form-inline" placeholder="mile" aria-label="Username" id="mile_input">
                        </div>
                        <div class="col-3 col-sm-3">
                            <div>
                                <button id="dir" class="btn btn-primary btn-block" >NOBO</button>
                            </div>
                        </div>
                        <div class="col-6 col-sm-6">
                        </div>
                    </div>

                    <table class="table table-fixed table-hover">
                        <thead>
                            <tr class="">
                                <th scope="col" class="col-sm-1">Mile</th>
                                <th scope="col" class="col-sm-2">Water</th>
                                <th scope="col" class="col-sm-9">Water Source Name</th>
                            </tr>
                        </thead>
                        <tbody id="list">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
                
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC2JH9aKFb5AuinMIDvZHF9CDuHHFgA2Go&callback=initMap"async defer></script>
    </body>
</html>

<script>
        var map;
        var icons = {
            r: {
                name: 'r',
                icon: '../static/img/blue_marker.png'
            },
            sel: {
                name: 'sel',
                icon: '../static/img/big_marker.png'
            },
            p: {
                name: 'p',
                icon: '../static/img/orange_marker.png'
            },
            u: {
                name: 'u',
                icon: '../static/img/red_marker.png'
            }
        };

        function reverse_children(element){
            for (var i=1;i<element.childNodes.length;i++){
                element.insertBefore(element.childNodes[i], element.firstChild);
            }
        }

        function getMethods(obj)
        {
            var res = [];
            for(var m in obj) {
                if(typeof obj[m] == "function") {
                    res.push(m)
                }
            }
            return res;
        }


        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: {lat: 34.4835464, lng: -116.763886},
                zoom: 7
            });
            data = {{data|tojson}};

            loc_list = $('#list');

            list_items = [];

            data.forEach(function(loc){
                var tr = $('<tr/>')
                    .appendTo(loc_list);
                
                var td1 = $('<td/>')
                    .text(loc.mile.toFixed(1))
                    .addClass("col-sm-1")
                    .appendTo(tr)

                var td_water = $('<td/>')
                    .text("")
                    .addClass("col-sm-2")
                    .appendTo(tr)

                var td2 = $('<td/>')
                    .text(loc.name.substr(0,40)+"...")
                    .addClass("col-sm-9")
                    .appendTo(tr)

                if (loc.class == 'r') {
                    var span = $('<span/>')
                        .text("Water Reliable")
                        .addClass("float-right")
                        .addClass("badge")
                        .addClass("badge-info")
                        .appendTo(td2)
                } else if (loc.class == 'p') {
                    var span = $('<span/>')
                        .text("Water Probable")
                        .addClass("float-right")
                        .addClass("badge")
                        .addClass("badge-warning")
                        .appendTo(td2)
                } else if (loc.class == 'u') {
                    var span = $('<span/>')
                        .text("Water Unreliable")
                        .addClass("float-right")
                        .addClass("badge")
                        .addClass("badge-danger")
                        .appendTo(td2)
                }



                position = {'lat': loc.lat, 'lng':loc.lon}
                var marker = new google.maps.Marker({
                    position: position, 
                    map: map,
                    icon: icons[loc.class].icon
                });

                marker.normal_icon = icons[loc.class].icon;

                marker.addListener('mouseover', function() {
                    tr.addClass('table-active');
                    marker.setIcon(icons['sel'].icon)
                });


                marker.addListener('mouseout', function() {
                    tr.removeClass('table-active');
                    marker.setIcon(marker.normal_icon)
                });

                tr.mouseover(function(){
                    marker.setIcon(icons['sel'].icon)
                })

                tr.mouseout(function(){
                    marker.setIcon(marker.normal_icon)
                })

                tr.mile = loc.mile;
                tr.water = td_water;

                list_items.push(tr)

            });

            
        }

    dir_btn = $('#dir');


    function updateListVisability() {
        var mile = parseFloat($('#mile_input').val())
        if (!isNaN(mile)) {
            list_items.forEach(function(item){

                if (mile < item.mile) {
                    var miles_left = item.mile - mile;
                    if (dir_btn.text() == "NOBO") {
                        item.show();
                    } else if (dir_btn.text() == "SOBO") {
                        item.hide();
                    }
                } else {

                    var miles_left = mile- item.mile;
                    if (dir_btn.text() == "NOBO") {
                        item.hide();
                    } else if (dir_btn.text() == "SOBO") {
                        item.show();
                    }
                }

                var water_needed = miles_left * 0.4;

                item.water.text(water_needed.toFixed(1)+" L");
            });
        } else {
            list_items.forEach(function(item){
                item.show();
                item.water.text("");
            });
        }
    }

    $('#mile_input').on('input', function () {
        updateListVisability()
    })

    $('#dir').click(function() {
        if (dir_btn.text() == "NOBO") {
            dir_btn.text("SOBO");
            reverse_children($('#list')[0]);
            updateListVisability();
            
        } else if (dir_btn.text() == "SOBO") {
            dir_btn.text("NOBO");
            reverse_children($('#list')[0]);
            updateListVisability();
        }
    })

</script>